#!/bin/bash
set -euo pipefail

# =============================================================================
# Buildkite Environment Hook
# =============================================================================
# Set environment variables based on GPU architecture or other metadata
# This runs before the command is executed
# =============================================================================

GPU_ARCH="${BUILDKITE_PLUGIN_GPU_ARCH:-}"

if [ -n "$GPU_ARCH" ]; then
  echo "Setting environment for GPU architecture: $GPU_ARCH"
  
  case $GPU_ARCH in
    v100)
      export CUDA_VISIBLE_DEVICES=0
      # Add any V100-specific env vars here
      ;;
    mi210|mi300a)
      export HIP_VISIBLE_DEVICES=0
      # Add any AMD-specific env vars here
      ;;
  esac
fi

# Set any global environment variables for CI
export BUILDKITE_CI=true
export CI=true
