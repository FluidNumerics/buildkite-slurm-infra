# Example Buildkite Pipeline for Multi-GPU Testing
# Copy this to your project at .buildkite/pipeline.yml and customize

steps:
  - label: ":amd-mi210: Build & Test - MI210"
    command: |
      # Commands run inside Slurm job via enroot/pyxis
      srun --container-image=/path/to/dev-environment-image.sqshfs \
           --container-mounts=${BUILDKITE_BUILD_CHECKOUT_PATH}:/workspace \
           --container-workdir=/workspace \
           bash -c "
             cmake -B build -S . \
               -DCMAKE_BUILD_TYPE=Release \
               -DCMAKE_CUDA_ARCHITECTURES=70 &&
             cmake --build build -j\$(nproc) &&
             ctest --test-dir build --output-on-failure
           "
    env:
      BUILDKITE_SLURM_PARTITION: "main"
      BUILDKITE_SLURM_GRES: "gpu:mi210:4"
      BUILDKITE_SLURM_TIME: "01:00:00"
      BUILDKITE_SLURM_NODES: "1"
      BUILDKITE_SLURM_CPUS_PER_TASK: "8"
      BUILDKITE_SLURM_NTASKS_PER_NODE: "1"
    agents:
      queue: "your-cluster-name"  # Use your cluster name or "*" for any cluster
      slurm: "true"

  - label: ":amd-mi300a: Build & Test - MI300A"
    command: |
      # Commands run inside Slurm job via enroot/pyxis
      srun --container-image=/path/to/dev-environment-image.sqshfs \
           --container-mounts=${BUILDKITE_BUILD_CHECKOUT_PATH}:/workspace \
           --container-workdir=/workspace \
           bash -c "
             cmake -B build -S . \
               -DCMAKE_BUILD_TYPE=Release \
               -DCMAKE_CUDA_ARCHITECTURES=70 &&
             cmake --build build -j\$(nproc) &&
             ctest --test-dir build --output-on-failure
           "
    env:
      BUILDKITE_SLURM_PARTITION: "main"
      BUILDKITE_SLURM_GRES: "gpu:mi210:4"
      BUILDKITE_SLURM_TIME: "01:00:00"
      BUILDKITE_SLURM_NODES: "1"
      BUILDKITE_SLURM_CPUS_PER_TASK: "8"
      BUILDKITE_SLURM_NTASKS_PER_NODE: "1"
    agents:
      queue: "your-cluster-name"  # Use your cluster name or "*" for any cluster
      slurm: "true"

  # Optional: Upload test results as artifacts
  - wait
  
  - label: ":package: Collect Artifacts"
    command: |
      buildkite-agent artifact upload "build/Testing/**/*"
    agents:
      queue: "your-cluster-name"
