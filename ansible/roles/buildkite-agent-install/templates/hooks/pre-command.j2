#!/bin/bash

set -euo pipefail

# Skip srun wrapping for buildkite-agent subcommands (pipeline upload,
# artifact upload, etc.) â€” these run on the agent and must not be
# submitted to SLURM.
if [[ "$BUILDKITE_COMMAND" == *"buildkite-agent "* ]]; then
    echo "--- :buildkite: buildkite-agent command detected, skipping srun wrap"
    exit 0
fi

# Function to construct srun command from slurm_ prefixed env vars
construct_srun_command() {
    local srun_cmd="{{ slurm_bin }}/srun"
    local has_slurm_opts=false
    local has_container_image=false
    local user_container_mounts=""
    local user_container_workdir=""

    # Iterate through all environment variables looking for slurm_ prefixed vars
    # set in the pipeline's env block
    for var in $(compgen -e); do
        if [[ $var == slurm_* ]]; then
            has_slurm_opts=true

            # Strip the slurm_ prefix and convert to srun flag format
            local opt_name=${var#slurm_}
            local opt_name_lower=$(echo "$opt_name" | tr '[:upper:]' '[:lower:]')
            local opt_name_hyphen=$(echo "$opt_name_lower" | tr '_' '-')

            # Get the value
            local opt_value="${!var}"

            # Check if this is a container image
            if [[ "$opt_name_hyphen" == "container-image" ]]; then
                has_container_image=true
            fi

            # Handle container mounts and workdir specially to allow appending
            if [[ "$opt_name_hyphen" == "container-mounts" ]]; then
                user_container_mounts="$opt_value"
                continue
            fi

            if [[ "$opt_name_hyphen" == "container-workdir" ]]; then
                user_container_workdir="$opt_value"
                continue
            fi

            # Construct the argument
            if [[ "$opt_value" == "true" ]]; then
                srun_cmd="$srun_cmd --$opt_name_hyphen"
            else
                srun_cmd="$srun_cmd --$opt_name_hyphen=\"$opt_value\""
            fi
        fi
    done

    # If container image is provided, add default mounts and workdir
    if [[ "$has_container_image" == "true" ]]; then
        # Build container mounts: default workspace mount + any user-provided mounts
        local container_mounts="${BUILDKITE_BUILD_CHECKOUT_PATH}:/workspace"
        if [[ -n "$user_container_mounts" ]]; then
            container_mounts="${container_mounts},${user_container_mounts}"
        fi
        srun_cmd="$srun_cmd --container-mounts=\"$container_mounts\""

        # Use user-provided workdir or default to /workspace
        local container_workdir="${user_container_workdir:-/workspace}"
        srun_cmd="$srun_cmd --container-workdir=\"$container_workdir\""
    fi

    if [[ "$has_slurm_opts" == "true" ]]; then
        echo "$srun_cmd"
    else
        echo ""
    fi
}

# Construct the srun command
SRUN_CMD=$(construct_srun_command)

if [[ -n "$SRUN_CMD" ]]; then
    # Export for use in the command
    export SRUN_CMD

    # Save original command
    export ORIGINAL_COMMAND="$BUILDKITE_COMMAND"

    # Replace the command with srun-wrapped version
    export BUILDKITE_COMMAND="$SRUN_CMD bash -c $(printf '%q' "$ORIGINAL_COMMAND")"

    echo "--- :slurm: Wrapping command with srun"
    echo "$SRUN_CMD"
else
    echo "--- :no_entry: SLURM options required"
    echo ""
    echo "This Buildkite agent runs jobs on a SLURM cluster. Running directly on the"
    echo "login node is not permitted. You must specify SLURM options via the env block."
    echo ""
    echo "Add SLURM options to your pipeline step using the 'env' block:"
    echo ""
    echo "  steps:"
    echo "    - label: \":rocket: My Job\""
    echo "      command: \"${BUILDKITE_COMMAND}\""
    echo "      env:"
    echo "        slurm_ntasks: \"1\""
    echo "        slurm_time: \"00:30:00\""
    echo "        slurm_partition: \"batch\""
    echo "      agents:"
    echo "        queue: \"{{ buildkite_cluster_name }}\""
    echo ""
    echo "Common SLURM options (use slurm_<option> format):"
    echo "  slurm_ntasks        - Number of tasks (e.g., \"4\")"
    echo "  slurm_cpus_per_task - CPUs per task (e.g., \"8\")"
    echo "  slurm_time          - Time limit (e.g., \"01:00:00\")"
    echo "  slurm_partition     - Partition name (e.g., \"batch\")"
    echo "  slurm_gpus          - Number of GPUs (e.g., \"1\")"
    echo "  slurm_mem           - Memory limit (e.g., \"16G\")"
    echo "  slurm_container_image - Enroot container image"
    echo ""
    echo "See: https://slurm.schedmd.com/srun.html for all available options."
    exit 1
fi
