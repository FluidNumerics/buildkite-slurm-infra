#!/bin/bash

set -euo pipefail

# Skip srun wrapping for buildkite-agent subcommands (pipeline upload,
# artifact upload, etc.) â€” these run on the agent and must not be
# submitted to SLURM.
if [[ "$BUILDKITE_COMMAND" == *"buildkite-agent "* ]]; then
    echo "--- :buildkite: buildkite-agent command detected, skipping srun wrap"
    exit 0
fi

# Validate that at least one slurm_ env var is set
has_slurm_opts=false
for var in $(compgen -e); do
    if [[ $var == slurm_* ]]; then
        has_slurm_opts=true
        break
    fi
done

if [[ "$has_slurm_opts" == "false" ]]; then
    echo "--- :no_entry: SLURM options required"
    echo ""
    echo "This Buildkite agent runs jobs on a SLURM cluster. Running directly on the"
    echo "login node is not permitted. You must specify SLURM options via the env block."
    echo ""
    echo "Add SLURM options to your pipeline step using the 'env' block:"
    echo ""
    echo "  steps:"
    echo "    - label: \":rocket: My Job\""
    echo "      command: \"${BUILDKITE_COMMAND}\""
    echo "      env:"
    echo "        slurm_ntasks: \"1\""
    echo "        slurm_time: \"00:30:00\""
    echo "        slurm_partition: \"batch\""
    echo "      agents:"
    echo "        queue: \"{{ buildkite_cluster_name }}\""
    echo ""
    echo "Common SLURM options (use slurm_<option> format):"
    echo "  slurm_ntasks        - Number of tasks (e.g., \"4\")"
    echo "  slurm_cpus_per_task - CPUs per task (e.g., \"8\")"
    echo "  slurm_time          - Time limit (e.g., \"01:00:00\")"
    echo "  slurm_partition     - Partition name (e.g., \"batch\")"
    echo "  slurm_gpus          - Number of GPUs (e.g., \"1\")"
    echo "  slurm_mem           - Memory limit (e.g., \"16G\")"
    echo "  slurm_container_image - Enroot container image"
    echo ""
    echo "See: https://slurm.schedmd.com/srun.html for all available options."
    exit 1
fi
